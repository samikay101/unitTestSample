# Trigger the pipeline on changes to the main branch and specific paths.
trigger:
  branches:
    include:
      - main
  paths:
    include:
      - 'MyLogicApp/**'
      - 'Tests/**'
      - 'deployments/MyLogicAppDeployment/pipelines/CI-Pipeline.yml'

# Use the Ubuntu agent image.
pool:
  vmImage: 'ubuntu-latest'

# Define variables for build configuration and solution file location.
variables:
  buildConfiguration: 'Debug'
  solution: 'Tests/Tests.sln'
  # Pattern for TRX test results generated by dotnet test.
  testResultsFiles: '**/TestResults/*.trx'

steps:
# 1. Add the local NuGet source from the Tests folder.
- script: |
    dotnet nuget add source "$(Build.SourcesDirectory)/Tests" --name local
  displayName: 'Add Local NuGet Source'

# 2. Restore external packages (using agent's default nuget.config which includes nuget.org)
- task: DotNetCoreCLI@2
  displayName: 'Restore External NuGet Packages'
  inputs:
    command: 'restore'
    projects: '$(solution)'
    arguments: '--ignore-failed-sources'
  continueOnError: true

# 3. Restore local packages by adding the local feed explicitly via the command line.
- task: DotNetCoreCLI@2
  displayName: 'Restore Local NuGet Packages'
  inputs:
    command: 'restore'
    projects: '$(solution)'
    arguments: '--source $(Build.SourcesDirectory)/Tests'
  continueOnError: true

# 4. Build the solution in Debug configuration.
- task: DotNetCoreCLI@2
  displayName: 'Build solution'
  inputs:
    command: 'build'
    projects: '$(solution)'
    arguments: '--configuration $(buildConfiguration)'

# 5. Run unit tests using dotnet test.
- task: DotNetCoreCLI@2
  displayName: 'Run unit tests'
  inputs:
    command: 'test'
    projects: '$(solution)'
    arguments: '--configuration $(buildConfiguration) --logger "trx;LogFileName=test_results.trx" --collect:"XPlat Code Coverage"'

# 6. Publish test results so they appear in the Azure DevOps Test Results tab.
- task: PublishTestResults@2
  displayName: 'Publish Test Results'
  inputs:
    testResultsFormat: 'VSTest'
    testResultsFiles: '$(testResultsFiles)'
    mergeTestResults: true
    testRunTitle: 'Unit Test Results'
  condition: always()
